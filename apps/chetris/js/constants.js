// === CHATRIS 전역 상수 ===
const C = {
  // 보드 크기
  COLS: 10,
  ROWS: 20,
  CELL: 10,

  // 캔버스
  CANVAS_W: 164,
  CANVAS_H: 252,

  // 레이아웃 위치
  BOARD_X: 6,
  BOARD_Y: 16,
  SIDE_X: 112,
  SIDE_Y: 16,
  CHAT_Y: 224,

  // 색상은 테마에서 동적으로 참조 (themes.js의 ThemeRegistry)
  get COLORS() { return themes.active.colors; },
  get NEON_POOL() { return themes.active.neonPool; },
  get BG() { return themes.active.bg; },
  get GRID_COLOR() { return themes.active.gridColor; },
  get BORDER_COLOR() { return themes.active.borderColor; },

  // 속도
  BASE_MOVE_DELAY: 70,
  BASE_DROP_DELAY: 800,
  LOCK_DELAY: 300,

  // 스폰 위치 (x 오프셋)
  SPAWN_X: { I: 3, O: 4, T: 3, S: 3, Z: 3, J: 3, L: 3 },

  // 피스 모양: [회전상태][셀인덱스] = [row, col]
  SHAPES: {
    I: [
      [[1,0],[1,1],[1,2],[1,3]],
      [[0,2],[1,2],[2,2],[3,2]],
      [[2,0],[2,1],[2,2],[2,3]],
      [[0,1],[1,1],[2,1],[3,1]],
    ],
    O: [
      [[0,0],[0,1],[1,0],[1,1]],
      [[0,0],[0,1],[1,0],[1,1]],
      [[0,0],[0,1],[1,0],[1,1]],
      [[0,0],[0,1],[1,0],[1,1]],
    ],
    T: [
      [[0,1],[1,0],[1,1],[1,2]],
      [[0,1],[1,1],[1,2],[2,1]],
      [[1,0],[1,1],[1,2],[2,1]],
      [[0,1],[1,0],[1,1],[2,1]],
    ],
    S: [
      [[0,1],[0,2],[1,0],[1,1]],
      [[0,1],[1,1],[1,2],[2,2]],
      [[1,1],[1,2],[2,0],[2,1]],
      [[0,0],[1,0],[1,1],[2,1]],
    ],
    Z: [
      [[0,0],[0,1],[1,1],[1,2]],
      [[0,2],[1,1],[1,2],[2,1]],
      [[1,0],[1,1],[2,1],[2,2]],
      [[0,1],[1,0],[1,1],[2,0]],
    ],
    J: [
      [[0,0],[1,0],[1,1],[1,2]],
      [[0,1],[0,2],[1,1],[2,1]],
      [[1,0],[1,1],[1,2],[2,2]],
      [[0,1],[1,1],[2,0],[2,1]],
    ],
    L: [
      [[0,2],[1,0],[1,1],[1,2]],
      [[0,1],[1,1],[2,1],[2,2]],
      [[1,0],[1,1],[1,2],[2,0]],
      [[0,0],[0,1],[1,1],[2,1]],
    ],
  },

  // SRS 월킥 데이터: "이전상태>다음상태" => [[dx, dy], ...]
  KICKS: {
    normal: {
      "0>1": [[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],
      "1>0": [[0,0],[1,0],[1,-1],[0,2],[1,2]],
      "1>2": [[0,0],[1,0],[1,-1],[0,2],[1,2]],
      "2>1": [[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],
      "2>3": [[0,0],[1,0],[1,1],[0,-2],[1,-2]],
      "3>2": [[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],
      "3>0": [[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],
      "0>3": [[0,0],[1,0],[1,1],[0,-2],[1,-2]],
    },
    I: {
      "0>1": [[0,0],[-2,0],[1,0],[-2,-1],[1,2]],
      "1>0": [[0,0],[2,0],[-1,0],[2,1],[-1,-2]],
      "1>2": [[0,0],[-1,0],[2,0],[-1,2],[2,-1]],
      "2>1": [[0,0],[1,0],[-2,0],[1,-2],[-2,1]],
      "2>3": [[0,0],[2,0],[-1,0],[2,1],[-1,-2]],
      "3>2": [[0,0],[-2,0],[1,0],[-2,-1],[1,2]],
      "3>0": [[0,0],[1,0],[-2,0],[1,-2],[-2,1]],
      "0>3": [[0,0],[-1,0],[2,0],[-1,2],[2,-1]],
    },
  },

  // 점수
  LINE_SCORES: [0, 100, 300, 500, 800],
  TSPIN_SCORES: [400, 800, 1200, 1600],
  COMBO_BONUS: 50,
};

// 유틸: 피스의 절대 셀 좌표 계산
function getCells(piece) {
  return C.SHAPES[piece.type][piece.rotation].map(([r, c]) => [
    r + piece.y,
    c + piece.x,
  ]);
}

// 유틸: 고스트 피스 (바닥까지 드롭) 계산
function getGhostY(board, piece) {
  let dy = 0;
  while (true) {
    const cells = C.SHAPES[piece.type][piece.rotation].map(([r, c]) => [
      r + piece.y + dy + 1,
      c + piece.x,
    ]);
    if (!board.isValid(cells)) break;
    dy++;
  }
  return piece.y + dy;
}
